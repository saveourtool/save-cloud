package com.saveourtool.save.entities.vulnerabilities

import com.saveourtool.save.entities.Organization
import com.saveourtool.save.entities.vulnerability.VulnerabilityDto
import com.saveourtool.save.entities.vulnerability.VulnerabilityLanguage
import com.saveourtool.save.spring.entity.BaseEntityWithDateAndDto

import com.fasterxml.jackson.annotation.JsonIgnore

import javax.persistence.*

/**
 * @property name name of vulnerability
 * @property vulnerabilityIdentifier vulnerability number in the public database
 * @property description description of vulnerability
 * @property progress vulnerability criticality percentage (1..100)
 * @property projects links to projects with this vulnerability
 * @property isActive admin vulnerability check flag
 * @property userId creator vulnerability
 * @property shortDescription short description of vulnerability
 * @property relatedLink
 * @property language
 * @property organization
 * @property dates
 **/
@Entity
@Suppress("LongParameterList")
class Vulnerability(

    var name: String,

    var shortDescription: String,

    var description: String,

    var progress: Int,

    var relatedLink: String?,

    @Enumerated(EnumType.STRING)
    var language: VulnerabilityLanguage,

    @OneToMany(
        fetch = FetchType.EAGER,
        cascade = [CascadeType.ALL],
        mappedBy = "vulnerability",
        targetEntity = VulnerabilityProject::class,
    )
    @JsonIgnore
    var projects: List<VulnerabilityProject>,

    @OneToMany(
        fetch = FetchType.EAGER,
        cascade = [CascadeType.ALL],
        mappedBy = "vulnerability",
        targetEntity = VulnerabilityDate::class,
    )
    @JsonIgnore
    var dates: List<VulnerabilityDate>,

    var isActive: Boolean,

    var userId: Long,

    var vulnerabilityIdentifier: String?,

    @ManyToOne
    @JoinColumn(name = "organization_id")
    var organization: Organization?,

) : BaseEntityWithDateAndDto<VulnerabilityDto>() {
    /**
     * @return a vulnerability dto
     */
    override fun toDto() = VulnerabilityDto(
        name = name,
        vulnerabilityIdentifier = vulnerabilityIdentifier,
        progress = progress,
        projects = projects.map { it.toDto() },
        description = null,
        shortDescription = shortDescription,
        relatedLink = relatedLink,
        language = language,
        isActive = isActive,
        userId = userId,
        organization = organization?.toDto(),
        dates = dates.map { it.toDto() },
    )

    /**
     * @return a vulnerability dto with description
     */
    fun toDtoWithDescription() = VulnerabilityDto(
        name = name,
        vulnerabilityIdentifier = vulnerabilityIdentifier,
        progress = progress,
        projects = projects.map { it.toDto() },
        description = description,
        shortDescription = shortDescription,
        relatedLink = relatedLink,
        language = language,
        isActive = isActive,
        userId = userId,
        organization = organization?.toDto(),
        dates = dates.map { it.toDto() },
    )
}
