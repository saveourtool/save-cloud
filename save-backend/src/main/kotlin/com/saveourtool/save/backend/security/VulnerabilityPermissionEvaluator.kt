package com.saveourtool.save.backend.security

import com.saveourtool.save.authservice.utils.AuthenticationDetails
import com.saveourtool.save.authservice.utils.userId
import com.saveourtool.save.backend.service.vulnerability.VulnerabilityService
import com.saveourtool.save.backend.utils.hasRole
import com.saveourtool.save.domain.Role

import com.saveourtool.save.permission.Permission
import com.saveourtool.save.utils.orNotFound
import org.springframework.security.core.Authentication
import org.springframework.stereotype.Component

/**
 * Class that is capable of assessing user permissions.
 */
@Component
class VulnerabilityPermissionEvaluator(
    private val vulnerabilityService: VulnerabilityService,
) {
    /**
     * Check permission for user to read, write and delete vulnerabilities by its [vulnerabilityName]
     *
     * @param authentication
     * @param vulnerabilityName
     * @param permission
     * @return true if user with [authentication] has [permission] for [vulnerabilityName]
     */
    fun hasPermission(
        authentication: Authentication?,
        vulnerabilityName: String,
        permission: Permission,
    ): Boolean {
        authentication ?: return false

        return when {
            authentication.hasRole(Role.SUPER_ADMIN) -> true
            permission == Permission.READ -> true
            else -> hasFullPermission(vulnerabilityName, authentication)
        }
    }

    /**
     * @param vulnerabilityName
     * @param authentication
     * @return check permission
     */
    fun hasFullPermission(vulnerabilityName: String, authentication: Authentication): Boolean {
        val vulnerability = vulnerabilityService.findByName(vulnerabilityName).orNotFound { "Not found vulnerability $vulnerabilityName" }
        val linkUsers = vulnerabilityService.getUsers(vulnerability.requiredId()).map { it.user.name }

        return vulnerability.userId == authentication.userId() || authentication.name in linkUsers
    }
}
