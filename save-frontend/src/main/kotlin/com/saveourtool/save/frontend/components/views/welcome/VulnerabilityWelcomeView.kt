/**
 * A view related to the sign-in view
 */

@file:Suppress(
    "FILE_WILDCARD_IMPORTS",
    "WildcardImport",
    "MAGIC_NUMBER",
    "FILE_NAME_MATCH_CLASS"
)

package com.saveourtool.save.frontend.components.views.welcome

import com.saveourtool.save.entities.vulnerability.VulnerabilityMetadata
import com.saveourtool.save.filters.VulnerabilityFilter
import com.saveourtool.save.frontend.components.views.welcome.pagers.vuln.renderVulnerabilityGeneralInfo
import com.saveourtool.save.frontend.externals.fontawesome.*
import com.saveourtool.save.frontend.themes.Colors
import com.saveourtool.save.frontend.utils.*
import com.saveourtool.save.info.OauthProviderInfo
import com.saveourtool.save.validation.FrontendRoutes
import js.core.jso
import org.w3c.fetch.Headers
import react.*
import react.dom.html.ReactHTML.div
import react.dom.html.ReactHTML.h1
import react.dom.html.ReactHTML.main
import react.dom.html.ReactHTML.span
import react.dom.html.ReactHTML.strong
import web.cssom.*
import kotlinx.browser.window
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json

val vulnWelcomeView: FC<WelcomeProps> = FC { props ->
    useBackground(Style.VULN_DARK)

    val (oauthProviders, setOauthProviders) = useState<List<OauthProviderInfo>>(emptyList())
    useRequest {
        val oauthProviderInfoList: List<OauthProviderInfo>? = get(
            "${window.location.origin}/sec/oauth-providers",
            Headers(),
            loadingHandler = ::loadingHandler,
            responseHandler = ::noopResponseHandler,
        ).run { if (ok) decodeFromJsonString() else null }
        oauthProviderInfoList?.let { setOauthProviders(it) }
    }

    val (vulnerabilities, setVulnerabilities) = useState<List<VulnerabilityMetadata>>(emptyList())
    useRequest {
        val vuln = post(
            url = "$apiUrl/vulnerabilities/by-filters",
            headers = jsonHeaders,
            body = Json.encodeToString(VulnerabilityFilter.approved),
            loadingHandler = ::loadingHandler,
            responseHandler = ::noopResponseHandler,
        ).unsafeMap {
            it.decodeFromJsonString<List<VulnerabilityMetadata>>()
        }
        setVulnerabilities(vuln)
    }

    main {
        className = ClassName("main-content mt-0 ps")
        div {
            className = ClassName("page-header align-items-start")
            style = jso {
                height = "100vh".unsafeCast<Height>()
                background = VULN_DARK_GRADIENT.unsafeCast<Background>()
                position = Position.relative
            }
            span {
                className = ClassName("mask bg-gradient-dark opacity-6")
            }

            particles()

            div {
                className = ClassName("row justify-content-center")

                // Sign-in header
                div {
                    className = ClassName("col-3 mr-4 mt-5")
                    div {
                        style = jso {
                            height = 30.rem
                        }
                        className = ClassName("card z-index-0")
                        // if user is not logged in - he needs to input credentials
                        props.userInfo?.let {
                            welcomeUserMenu(props.userInfo, Colors.VULN_PRIMARY) {
                                menuTextAndLink("Vulnerability database", FrontendRoutes.VULNERABILITIES, faCode)
                                hrNoMargin()
                                menuTextAndLink("Propose vulnerability", FrontendRoutes.CREATE_VULNERABILITY, faPlus)
                                hrNoMargin()
                                menuTextAndLink("Top rating", FrontendRoutes.VULN_TOP_RATING, faTrophy)
                            }
                        } ?: inputCredentialsView(
                            oauthProviders,
                            Colors.VULN_PRIMARY,
                            "/${FrontendRoutes.VULNERABILITIES}"
                        )
                    }
                    stats(vulnerabilities)
                }

                div {
                    className = ClassName("col-6")
                    renderVulnerabilityGeneralInfo()
                }
            }
        }
    }
}

/**
 * add a card getting all vulnerabilities and return nums
 *
 * @param vulnerabilities
 */
fun ChildrenBuilder.stats(vulnerabilities: List<VulnerabilityMetadata>) {
    div {
        className = ClassName("card border border-primary rounded rounded-pill col mt-4 justify-content-center")
        style = jso {
            height = 15.rem
        }
        div {
            className = ClassName("row justify-content-center")
            h1 {
                className = ClassName("text-primary")
                +vulnerabilities.size.toString()
                style = jso {
                    fontSize = 4.rem
                }
            }
        }
        div {
            className = ClassName("row justify-content-center")
            strong {
                className = ClassName("d-inline-block mb-2 card-text")
                +"Total number of submitted vulnerabilities"
            }
        }
    }
}
