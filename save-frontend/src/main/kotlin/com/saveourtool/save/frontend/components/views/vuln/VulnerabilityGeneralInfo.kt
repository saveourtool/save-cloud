package com.saveourtool.save.frontend.components.views.vuln

import com.saveourtool.save.entities.cosv.VulnerabilityExt
import com.saveourtool.save.frontend.components.basic.renderAvatar
import com.saveourtool.save.frontend.components.basic.renderUserAvatarWithName
import com.saveourtool.save.frontend.components.basic.userBoard
import com.saveourtool.save.frontend.externals.fontawesome.*
import com.saveourtool.save.frontend.utils.*
import com.saveourtool.save.info.UserInfo
import com.saveourtool.save.utils.getRelatedLink
import com.saveourtool.save.utils.toUnixCalendarFormat

import react.*
import react.dom.html.ReactHTML.div
import react.dom.html.ReactHTML.h6
import react.dom.html.ReactHTML.hr
import react.dom.html.ReactHTML.label
import react.dom.html.ReactHTML.textarea
import react.router.dom.Link
import web.cssom.ClassName
import web.cssom.rem

import kotlinx.datetime.TimeZone
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json

/**
 * [FC] that is used to display some general vulnerability information
 */
@Suppress("EMPTY_BLOCK_STRUCTURE_ERROR", "MAGIC_NUMBER")
val vulnerabilityGeneralInfo: FC<VulnerabilityGeneralInfo> = FC { props ->

    val (isEditDisabled, setIsEditDisabled) = useState(true)
    val (vulnerability, setVulnerability) = useStateFromProps(props.vulnerability)

    val enrollRequest = useDeferredRequest {
        post(
            "$apiUrl/vulnerabilities/update",
            jsonHeaders,
            Json.encodeToString(vulnerability),
            loadingHandler = ::noopLoadingHandler,
        )
    }

    with(props.vulnerability) {
        div {
            className = ClassName("card shadow mt-3 mb-4")

            div {
                className = ClassName("card-body")
                div {
                    className = ClassName("row mb-4")
                    div {
                        className = ClassName("col-6 align-self-center")
                        div {
                            className = ClassName("font-weight-bold text-primary-blue text-uppercase")
                            +metadata.cosvId
                        }
                    }
                    if (isEditDisabled) {
                        if (props.userInfo?.isSuperAdmin() == true || props.userInfo?.name == metadata.user.name) {
                            buttonBuilder(
                                labelBuilder = {
                                    +"Edit "
                                    fontAwesomeIcon(icon = faEdit)
                                },
                                "link", isOutline = true, classes = "text-xs text-muted text-left ml-auto"
                            ) {
                                setIsEditDisabled(false)
                            }
                        }
                    } else {
                        buttonBuilder(faCheck, "link", isOutline = true, classes = "text-muted text-left ml-auto") {
                            enrollRequest()
                            setIsEditDisabled(true)
                        }
                        buttonBuilder(faTimesCircle, null, isOutline = true) {
                            setVulnerability(props.vulnerability)
                            setIsEditDisabled(true)
                        }
                    }
                }
                textarea {
                    className = ClassName("auto_height form-control-plaintext pt-0 pb-0 text-gray-900")
                    value = metadata.summary
                    rows = 2
                }
                hr { }
                div {
                    className = ClassName("d-flex justify-content-between align-items-center")
                    label {
                        className = ClassName("m-0")
                        +"Creation time:"
                    }
                    label {
                        className = ClassName("m-0")
                        +metadata.published.toUnixCalendarFormat(TimeZone.currentSystemDefault())
                    }
                }
                div {
                    className = ClassName("d-flex justify-content-between align-items-center")
                    label {
                        className = ClassName("m-0")
                        +"Last updated time:"
                    }
                    label {
                        className = ClassName("m-0")
                        +(metadata.modified.toUnixCalendarFormat(TimeZone.currentSystemDefault()))
                    }
                }
                hr { }
                h6 {
                    className = ClassName("font-weight-bold text-primary-blue mb-4")
                    +"Description"
                }
                textarea {
                    className = ClassName("auto_height form-control-plaintext pt-0 pb-0 text-gray-900")
                    value = metadata.details
                    disabled = isEditDisabled
                    rows = 8
                    onChange = { event ->
                        setVulnerability { vulnerability ->
                            vulnerability.copy(
                                metadata = metadata.copy(
                                    details = event.target.value
                                )
                            )
                        }
                    }
                }
                if (props.canEditVulnerability || props.vulnerability.tags.isNotEmpty()) {
                    hr { }
                    h6 {
                        className = ClassName("font-weight-bold text-primary-blue mb-4")
                        +"Tags"
                    }
                    div {
                        vulnerabilityTagsComponent {
                            userInfo = props.userInfo
                            tags = props.vulnerability.tags
                            this.vulnerability = props.vulnerability
                            fetchVulnerability = props.fetchVulnerability
                            canEditVulnerability = props.canEditVulnerability
                        }
                    }
                }
                cosv.getRelatedLink()
                    ?.takeIf { it.isNotEmpty() }
                    ?.run {
                        hr { }
                        h6 {
                            className = ClassName("font-weight-bold text-primary-blue mb-4")
                            +"Related link"
                        }
                        Link {
                            to = this@run
                            +this@run
                        }
                    }
                metadata.user.run {
                    hr { }
                    h6 {
                        className = ClassName("font-weight-bold text-primary-blue mb-3")
                        +"Author"
                    }
                    renderUserAvatarWithName(this@run, isHorizontal = true, classes = "mr-2") {
                        height = 4.rem
                        width = 4.rem
                    }
                }

                metadata.organization?.run {
                    hr { }
                    h6 {
                        className = ClassName("font-weight-bold text-primary-blue mb-3")
                        +"Organization"
                    }
                    Link {
                        renderAvatar(this@run) {
                            height = 4.rem
                            width = 4.rem
                        }
                        to = "/${this@run.name}"
                        +" ${this@run.name}"
                    }
                }
                if (saveContributors.isNotEmpty()) {
                    hr { }
                    h6 {
                        className = ClassName("font-weight-bold text-primary-blue mb-4")
                        +"Collaborators"
                    }
                    userBoard {
                        users = saveContributors
                        avatarOuterClasses = "col-2"
                    }
                }
            }
        }
    }
}

/**
 * [Props] for [vulnerabilityGeneralInfo] component
 */
external interface VulnerabilityGeneralInfo : Props {
    /**
     * [VulnerabilityExt] to display info about
     */
    var vulnerability: VulnerabilityExt

    /**
     * Callback to fetch updated vulnerability
     */
    var fetchVulnerability: () -> Unit

    /**
     * FLag that defines if current user can edit vulnerability or not
     */
    var canEditVulnerability: Boolean

    /**
     * Currently logged-in user or null
     */
    var userInfo: UserInfo?
}
