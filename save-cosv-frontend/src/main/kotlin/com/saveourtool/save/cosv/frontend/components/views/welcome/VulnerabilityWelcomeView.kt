/**
 * A view related to the sign-in view
 */

@file:Suppress(
    "FILE_WILDCARD_IMPORTS",
    "WildcardImport",
    "MAGIC_NUMBER",
    "FILE_NAME_MATCH_CLASS"
)

package com.saveourtool.save.cosv.frontend.components.views.welcome

import com.saveourtool.save.cosv.frontend.components.views.welcome.pagers.vuln.renderVulnerabilityGeneralInfo
import com.saveourtool.save.filters.VulnerabilityFilter.Companion.approved
import com.saveourtool.save.frontend.common.components.views.welcome.hrNoMargin
import com.saveourtool.save.frontend.common.components.views.welcome.inputCredentialsView
import com.saveourtool.save.frontend.common.components.views.welcome.menuTextAndLink
import com.saveourtool.save.frontend.common.components.views.welcome.welcomeUserMenu
import com.saveourtool.save.frontend.common.externals.fontawesome.*
import com.saveourtool.save.frontend.common.externals.i18next.TranslationFunction
import com.saveourtool.save.frontend.common.externals.i18next.useTranslation
import com.saveourtool.save.frontend.common.themes.Colors
import com.saveourtool.save.frontend.common.utils.*
import com.saveourtool.save.frontend.common.utils.UserInfoAwarePropsWithChildren
import com.saveourtool.save.frontend.common.utils.useBackground
import com.saveourtool.save.info.OauthProviderInfo
import com.saveourtool.save.validation.FrontendRoutes

import js.core.jso
import org.w3c.fetch.Headers
import react.*
import react.dom.html.ReactHTML.div
import react.dom.html.ReactHTML.h1
import react.dom.html.ReactHTML.main
import react.dom.html.ReactHTML.span
import react.dom.html.ReactHTML.strong
import react.router.dom.Link
import web.cssom.*

import kotlinx.browser.window
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json

const val FIRST_RAW_HEIGHT = 33
const val SECOND_RAW_HEIGHT = 15
const val BIG_FONT_SIZE = 3.5

val vulnWelcomeView: FC<UserInfoAwarePropsWithChildren> = FC { props ->
    useBackground(Style.VULN_DARK)
    val (t) = useTranslation("welcome")

    val (oauthProviders, setOauthProviders) = useState<List<OauthProviderInfo>>(emptyList())
    useRequest {
        val oauthProviderInfoList: List<OauthProviderInfo>? = get(
            "${window.location.origin}/sec/oauth-providers",
            Headers(),
            loadingHandler = ::loadingHandler,
            responseHandler = ::noopResponseHandler,
        ).run { if (ok) decodeFromJsonString() else null }
        oauthProviderInfoList?.let { setOauthProviders(it) }
    }

    val (vulnerabilitiesNumber, setVulnerabilitiesNumber) = useState(0L)
    useRequest {
        val vuln = post(
            url = "$apiUrl/vulnerabilities/count/by-filter",
            headers = jsonHeaders,
            loadingHandler = ::loadingHandler,
            responseHandler = ::noopResponseHandler,
            body = Json.encodeToString(approved),
        ).unsafeMap {
            it.decodeFromJsonString<Long>()
        }
        setVulnerabilitiesNumber(vuln)
    }

    main {
        className = ClassName("main-content mt-0 ps")
        div {
            className = ClassName("page-header align-items-start")
            style = jso {
                height = "100vh".unsafeCast<Height>()
                background = VULN_DARK_GRADIENT.unsafeCast<Background>()
                position = Position.relative
            }
            span {
                className = ClassName("mask bg-gradient-dark opacity-6")
            }

            particles()

            div {
                className = ClassName("row justify-content-center")

                // Sign-in header
                div {
                    className = ClassName("col-3 mr-4 mt-5")
                    div {
                        style = jso {
                            height = FIRST_RAW_HEIGHT.rem
                        }
                        className = ClassName("card z-index-0")
                        // if user is not logged in - he needs to input credentials
                        props.userInfo?.let {
                            welcomeUserMenu(props.userInfo, Colors.VULN_PRIMARY, t) {
                                menuTextAndLink("Vulnerability database".t(), FrontendRoutes.VULNERABILITIES, faCode)
                                hrNoMargin()
                                menuTextAndLink("Propose vulnerability".t(), FrontendRoutes.VULN_CREATE, faPlus)
                                hrNoMargin()
                                menuTextAndLink("Top rating".t(), FrontendRoutes.VULN_TOP_RATING, faTrophy)
                                hrNoMargin()
                                menuTextAndLink("Go to main page".t(), FrontendRoutes.INDEX, faHome)
                            }
                        } ?: inputCredentialsView(
                            oauthProviders,
                            Colors.VULN_PRIMARY,
                            "/${FrontendRoutes.VULNERABILITIES}",
                            t
                        )
                    }
                    stats(vulnerabilitiesNumber, t)
                }

                div {
                    className = ClassName("col-6")
                    renderVulnerabilityGeneralInfo(t)
                }
            }
        }
    }
}

/**
 * add a card getting all vulnerabilities and return nums
 *
 * @param t [TranslationFunction] received from [com.saveourtool.save.frontend.externals.i18next.useTranslation] hook
 * @param vulnerabilitiesNumber
 */
@Suppress("IDENTIFIER_LENGTH")
fun ChildrenBuilder.stats(vulnerabilitiesNumber: Long, t: TranslationFunction) {
    Link {
        to = "/${FrontendRoutes.VULNERABILITIES}"
        div {
            className =
                    ClassName("card rounded rounded-pill col mt-4 justify-content-center button_animated_card")
            style = jso {
                height = SECOND_RAW_HEIGHT.rem
            }
            div {
                className = ClassName("row justify-content-center")
                h1 {
                    +vulnerabilitiesNumber.toString()
                    style = jso {
                        fontSize = BIG_FONT_SIZE.rem
                    }
                }
            }
            div {
                className = ClassName("row justify-content-center")
                strong {
                    className = ClassName("d-inline-block mb-2 card-text")
                    +"Total number of submitted vulnerabilities".t()
                }
            }
        }
    }
}
